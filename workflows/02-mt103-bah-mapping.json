{
    "id": "02-mt103-bah-mapper",
    "name": "MT103 Business Application Header Mapping for CBPR+",
    "description": "Maps MT103 message to ISO 20022 Business Application Header (AppHdr) using head.001.001.02 schema",
    "condition": {
        "and": [
            {"==": [{"var": "SwiftMT.message_type"}, "103"]},
            {"==": [{"var": "progress.workflow_id"}, "01-parser"]},
            {"==": [{"var": "progress.task_id"}, "parse_mt_message"]},
            {"==": [{"var": "progress.status_code"}, 200]}
        ]
    },
    "tasks": [
        {
            "id": "map_cbpr_plus_business_application_header",
            "name": "Map CBPR+ Business Application Header (AppHdr)",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.AppHdr.Fr.FIId.FinInstnId.BICFI",
                            "logic": { "val": [ "data", "SwiftMT", "fields", "52A", "bic" ]}
                        },
                        {
                            "path": "data.AppHdr.To.FIId.FinInstnId.BICFI",
                            "logic": { "val": [ "data", "SwiftMT", "fields", "57A", "bic" ] }
                        },
                        {
                            "path": "data.AppHdr.BizMsgIdr",
                            "logic": {
                                "cat": [
                                    { "val": [ "data", "SwiftMT", "fields", "20", "transaction_reference" ] },
                                    "-pacs.008-001"
                                ]
                            }
                        },
                        {
                            "path": "data.AppHdr.MsgDefIdr",
                            "logic": "pacs.008.001.08"
                        },
                        {
                            "path": "data.AppHdr.BizSvc",
                            "logic": "swift.cbprplus.02"
                        },
                        {
                            "path": "data.AppHdr.CreDt",
                            "logic": {
                                "if": [
                                    { "val": [ "data", "SwiftMT", "fields", "32A", "value_date" ] },
                                    {
                                        "cat": [
                                            { "var": "data.SwiftMT.fields.32A.value_date" },
                                            "T",
                                            {
                                                "format_date": [
                                                    { "now": [] },
                                                    "HH:mm:ss"
                                                ]
                                            },
                                            "+00:00"
                                        ]
                                    },
                                    "9999-12-31T00:00:00+00:00"
                                ]
                            }
                        },
                        {
                            "path": "data.AppHdr.CpyDplct",
                            "logic": "CODU"
                        },
                        {
                            "path": "data.AppHdr.PssblDplct",
                            "logic": false
                        },
                        {
                            "path": "data.AppHdr.Prty",
                            "logic": {
                                "if": [
                                    { "==": [{ "val": [ "data", "SwiftMT", "fields", "23B", "bank_operation_code" ] }, "URGP"] },
                                    "URGT",
                                    "NORM"
                                ]
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_cbpr_plus_message_metadata",
            "name": "Map CBPR+ Message Metadata",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.AppHdr.Rltd.Fr.FIId.FinInstnId.BICFI",
                            "logic": { "val": [ "data", "SwiftMT", "fields", "52A", "bic" ] }
                        },
                        {
                            "path": "data.AppHdr.Rltd.To.FIId.FinInstnId.BICFI",
                            "logic": { "val": [ "data", "SwiftMT", "fields", "57A", "bic" ] }
                        },
                        {
                            "path": "data.AppHdr.Rltd.MsgDefIdr",
                            "logic": "pacs.008.001.08"
                        },
                        {
                            "path": "data.AppHdr.Rltd.BizMsgIdr",
                            "logic": { "val": [ "data", "SwiftMT", "fields", "20", "transaction_reference" ] }
                        },
                        {
                            "path": "data.AppHdr.Rltd.CreDt",
                            "logic": {
                                "if": [
                                    { "val": [ "data", "SwiftMT", "fields", "32A", "value_date" ] },
                                    {
                                        "cat": [
                                            { "var": "data.SwiftMT.fields.32A.value_date" },
                                            "T",
                                            {
                                                "format_date": [
                                                    { "now": [] },
                                                    "HH:mm:ss"
                                                ]
                                            },
                                            "+00:00"
                                        ]
                                    },
                                    "9999-12-31T00:00:00+00:00"
                                ]
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "publish_header_xml",
            "name": "Publish Header XML",
            "function": {
                "name": "publish",
                "input": {
                    "input_field_name": "AppHdr",
                    "output_field_name": "header_xml",
                    "source_format": "MT103.Header"
                }
            }
        }
    ]
} 