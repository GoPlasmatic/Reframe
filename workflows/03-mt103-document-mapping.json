{
    "id": "03-mt103-document-mapper",
    "name": "MT103 Document Mapping for CBPR+",
    "description": "Maps MT103 message document components to ISO 20022 pacs.008.001.08 Credit Transfer Transaction Information structure",
    "condition": {
        "and": [
            {"==": [{"var": "SwiftMT.message_type"}, "103"]},
            {"==": [{"var": "progress.workflow_id"}, "02-mt103-bah-mapper"]},
            {"==": [{"var": "progress.status_code"}, 200]}
        ]
    },
    "tasks": [
        {
            "id": "map_credit_transfer_transaction_info",
            "name": "Map Credit Transfer Transaction Information - Payment Identifiers",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MXdocument.@xmlns",
                            "logic": "urn:iso:std:iso:20022:tech:xsd:pacs.008.001.08"
                        },
                        {
                            "path": "data.MXdocument.FIToFICstmrCdtTrf.GrpHdr.MsgId",
                            "logic": {
                                "cat": [
                                    { "var": "data.SwiftMT.20" },
                                    "-pacs.008-001"
                                ]
                            }
                        },
                        {
                            "path": "data.MXdocument.FIToFICstmrCdtTrf.GrpHdr.CreDtTm",
                            "logic": {
                                "if": [
                                    { "var": "data.parsed_32A.formatted_date" },
                                    {
                                        "cat": [
                                            { "var": "data.parsed_32A.formatted_date" },
                                            "T00:00:00Z"
                                        ]
                                    },
                                    "2024-01-01T00:00:00Z"
                                ]
                            }
                        },
                        {
                            "path": "data.MXdocument.FIToFICstmrCdtTrf.GrpHdr.NbOfTxs",
                            "logic": "1"
                        },
                        {
                            "path": "data.MXdocument.FIToFICstmrCdtTrf.GrpHdr.SttlmInf.SttlmMtd",
                            "logic": "INDA"
                        },
                        {
                            "path": "data.MXdocument.FIToFICstmrCdtTrf.CdtTrfTxInf.PmtId.InstrId",
                            "logic": { "var": "data.SwiftMT.20" }
                        },
                        {
                            "path": "data.MXdocument.FIToFICstmrCdtTrf.CdtTrfTxInf.PmtId.EndToEndId",
                            "logic": { "var": "data.SwiftMT.20" }
                        },
                        {
                            "path": "data.MXdocument.FIToFICstmrCdtTrf.CdtTrfTxInf.PmtId.UETR",
                            "logic": {
                                "if": [
                                    { "var": "data.SwiftMT.121" },
                                    { "var": "data.SwiftMT.121" },
                                    { "var": "data.SwiftMT.20" }
                                ]
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_settlement_information",
            "name": "Map Settlement Information",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MXdocument.FIToFICstmrCdtTrf.CdtTrfTxInf.IntrBkSttlmAmt.@Ccy",
                            "logic": {
                                "if": [
                                    { "var": "data.parsed_32A.currency" },
                                    { "var": "data.parsed_32A.currency" },
                                    "USD"
                                ]
                            }
                        },
                        {
                            "path": "data.MXdocument.FIToFICstmrCdtTrf.CdtTrfTxInf.IntrBkSttlmAmt.$value",
                            "logic": {
                                "if": [
                                    { "var": "data.parsed_32A.numeric_amount" },
                                    { "var": "data.parsed_32A.numeric_amount" },
                                    1000.0
                                ]
                            }
                        },
                        {
                            "path": "data.MXdocument.FIToFICstmrCdtTrf.CdtTrfTxInf.IntrBkSttlmDt",
                            "logic": {
                                "if": [
                                    { "var": "data.parsed_32A.formatted_date" },
                                    {
                                        "cat": [
                                            { "var": "data.parsed_32A.formatted_date" },
                                            "T00:00:00+00:00"
                                        ]
                                    },
                                    "2024-01-01T00:00:00+00:00"
                                ]
                            }
                        },
                        {
                            "path": "data.MXdocument.FIToFICstmrCdtTrf.CdtTrfTxInf.InstdAmt.@Ccy",
                            "logic": {
                                "if": [
                                    { "var": "data.parsed_32A.currency" },
                                    { "var": "data.parsed_32A.currency" },
                                    "USD"
                                ]
                            }
                        },
                        {
                            "path": "data.MXdocument.FIToFICstmrCdtTrf.CdtTrfTxInf.InstdAmt.$value",
                            "logic": {
                                "if": [
                                    { "var": "data.parsed_32A.numeric_amount" },
                                    { "var": "data.parsed_32A.numeric_amount" },
                                    1000.0
                                ]
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_charge_information",
            "name": "Map Charge Information",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MXdocument.FIToFICstmrCdtTrf.CdtTrfTxInf.ChrgBr",
                            "logic": {
                                "if": [
                                    { "==": [{ "var": "data.SwiftMT.71A" }, "OUR"] },
                                    "DEBT",
                                    {
                                        "if": [
                                            { "==": [{ "var": "data.SwiftMT.71A" }, "BEN"] },
                                            "CRED",
                                            "SHAR"
                                        ]
                                    }
                                ]
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_agent_information",
            "name": "Map Agent Information",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MXdocument.FIToFICstmrCdtTrf.CdtTrfTxInf.InstgAgt.FinInstnId.BICFI",
                            "logic": { "var": "data.SwiftMT.52A" }
                        },
                        {
                            "path": "data.MXdocument.FIToFICstmrCdtTrf.CdtTrfTxInf.InstgAgt.FinInstnId.Nm",
                            "logic": {
                                "if": [
                                    { "var": "data.SwiftMT.52A_name" },
                                    { "var": "data.SwiftMT.52A_name" },
                                    "BNP Paribas"
                                ]
                            }
                        },
                        {
                            "path": "data.MXdocument.FIToFICstmrCdtTrf.CdtTrfTxInf.InstdAgt.FinInstnId.BICFI",
                            "logic": { "var": "data.SwiftMT.57A" }
                        },
                        {
                            "path": "data.MXdocument.FIToFICstmrCdtTrf.CdtTrfTxInf.InstdAgt.FinInstnId.Nm",
                            "logic": {
                                "if": [
                                    { "var": "data.SwiftMT.57A_name" },
                                    { "var": "data.SwiftMT.57A_name" },
                                    "Deutsche Bank"
                                ]
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_debtor_information",
            "name": "Map Debtor Information",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MXdocument.FIToFICstmrCdtTrf.CdtTrfTxInf.Dbtr.Nm",
                            "logic": { "var": "data.SwiftMT.50K" }
                        },
                        {
                            "path": "data.MXdocument.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAcct.Id.Othr.Id",
                            "logic": {
                                "if": [
                                    { "var": "data.SwiftMT.50A" },
                                    { "var": "data.SwiftMT.50A" },
                                    {
                                        "if": [
                                            { "var": "data.SwiftMT.50K" },
                                            { "substr": [{ "var": "data.SwiftMT.50K" }, 0, 35] },
                                            "NOTPROVIDED"
                                        ]
                                    }
                                ]
                            }
                        },
                        {
                            "path": "data.MXdocument.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAgt.FinInstnId.BICFI",
                            "logic": { "var": "data.SwiftMT.52A" }
                        },
                        {
                            "path": "data.MXdocument.FIToFICstmrCdtTrf.CdtTrfTxInf.DbtrAgt.FinInstnId.Nm",
                            "logic": { "if": [
                                    { "var": "data.SwiftMT.52A_name" },
                                    { "var": "data.SwiftMT.52A_name" },
                                    "BNP Paribas"
                                ]
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_creditor_information",
            "name": "Map Creditor Information",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MXdocument.FIToFICstmrCdtTrf.CdtTrfTxInf.Cdtr.Nm",
                            "logic": { "if": [
                                    { "var": "data.SwiftMT.59" },
                                    { "var": "data.SwiftMT.59" },
                                    "NOTPROVIDED"
                                ]
                            }
                        },
                        {
                            "path": "data.MXdocument.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAcct.Id.Othr.Id",
                            "logic": {
                                "if": [
                                    { "var": "data.SwiftMT.59A" },
                                    { "var": "data.SwiftMT.59A" },
                                    {
                                        "if": [
                                            { "var": "data.SwiftMT.59" },
                                            { "substr": [{ "var": "data.SwiftMT.59" }, 0, 35] },
                                            "NOTPROVIDED"
                                        ]
                                    }
                                ]
                            }
                        },
                        {
                            "path": "data.MXdocument.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.BICFI",
                            "logic": { "var": "data.SwiftMT.57A" }
                        },
                        {
                            "path": "data.MXdocument.FIToFICstmrCdtTrf.CdtTrfTxInf.CdtrAgt.FinInstnId.Nm",
                            "logic": { "if": [
                                    { "var": "data.SwiftMT.57A_name" },
                                    { "var": "data.SwiftMT.57A_name" },
                                    "Deutsche Bank"
                                ]
                            }
                        }
                    ]
                }
            }
        },
        {
            "id": "map_remittance_information",
            "name": "Map Remittance Information",
            "function": {
                "name": "map",
                "input": {
                    "mappings": [
                        {
                            "path": "data.MXdocument.FIToFICstmrCdtTrf.CdtTrfTxInf.RmtInf.Ustrd",
                            "logic": { "var": "data.SwiftMT.70" }
                        }
                    ]
                }
            }
        },
        {
            "id": "publish_document_xml",
            "name": "Publish Document XML",
            "function": {
                "name": "publish",
                "input": {
                    "input_field_name": "MXdocument",
                    "output_field_name": "documents",
                    "source_format": "MT103.Document"
                }
            }
        }
    ]
} 